# Monet风格转换 CycleGAN

基于CycleGAN的照片与莫奈画作风格转换项目。该项目实现了双向风格转换：
- 将真实照片转换为莫奈画作风格
- 将莫奈画作风格转换为真实照片风格

## 项目特点

- 双向风格转换
- 改进的FID评估方法
- 优化的训练策略
- 使用Wandb进行实验跟踪
- 混合精度训练
- 自动学习率调整

## 环境要求

```bash
torch>=1.7.0
torchvision>=0.8.0
wandb
numpy
pillow
tqdm
scipy
pytorch-fid
```

## 项目结构

```
.
├── data/
│   ├── trainA/    # 训练集照片
│   ├── trainB/    # 训练集莫奈画作
│   ├── testA/     # 测试集照片
│   └── testB/     # 测试集莫奈画作
├── models/
│   ├── generator.py       # 生成器模型
│   └── discriminator.py   # 判别器模型
├── utils/
│   ├── dataset.py        # 数据集加载
│   └── fid_score.py      # FID分数计算
├── train.py              # 训练脚本
├── recalculate_fid.py    # FID重新计算脚本
└── README.md
```

## 技术细节

### 模型架构

#### 生成器 (Generator)
- 基于ResNet架构
- 9个残差块用于特征提取和转换
- 使用实例归一化避免风格信息损失
- 反射填充保持边缘一致性
- Tanh激活函数确保输出范围在[-1,1]

#### 判别器 (Discriminator)
- PatchGAN结构，关注局部特征
- 实例归一化
- LeakyReLU激活函数（斜率0.2）
- 70x70感受野

### 损失函数

1. GAN Loss
   - 使用MSE损失
   - 带标签平滑的真实标签和虚假标签
   - 用于提升生成图像的真实性

2. Cycle Loss (循环一致性损失)
   - L1损失
   - 权重：20.0
   - 确保图像转换的可逆性
   - 保持内容的一致性

3. Identity Loss (身份损失)
   - L1损失
   - 权重：10.0
   - 帮助保持颜色和整体构图
   - 防止不必要的风格转换

### 评估指标

#### FID分数 (Fréchet Inception Distance)
- 使用预训练的Inception-v3模型提取特征
- 计算真实图像和生成图像特征分布的距离
- 分别评估两个域的转换质量：
  - 照片域FID：真实照片vs生成照片
  - 莫奈域FID：真实莫奈画作vs生成莫奈画作
- 每10个epoch计算一次
- 值越低表示生成质量越好

## 训练策略

### 基础配置
```python
config = {
    'epochs': 200,
    'batch_size': 8,
    'lr': 0.0001,
    'b1': 0.5,
    'b2': 0.999,
    'lambda_cycle': 15.0,
    'lambda_identity': 7.5,
    'gradient_accumulation_steps': 4
}
```

### 优化技巧
1. 学习率调度：
   - 预热阶段（5个epoch）
   - 恒定学习率阶段
   - 线性衰减（从100epoch开始）

2. 训练稳定性：
   - 梯度累积（每4步更新一次）
   - 混合精度训练（降低显存使用）
   - 较大的batch size（8）提高稳定性

3. 检查点保存：
   - 每5个epoch保存一次
   - 保存完整的训练状态
   - 支持断点续训

## 实验过程与结果

### 第一阶段（0-200 epochs）
[详细内容见下方实验结果部分]

### 优化尝试（200-280 epochs）
[详细内容见下方实验结果部分]

## 使用说明

1. 准备数据：
```bash
# 将数据放在data目录下
data/
  ├── trainA/  # 照片训练集
  ├── trainB/  # 莫奈画作训练集
  ├── testA/   # 照片测试集
  └── testB/   # 莫奈画作测试集
```

2. 训练模型：
```bash
python train.py
```

3. 重新计算FID（如需要）：
```bash
python recalculate_fid.py
```

## 实验结果

### 第一阶段（200 epochs）
- 训练时长：200 epochs
- 最终FID分数：
  - 照片域FID：41.59
  - 莫奈域FID：51.23
  - 平均FID：46.41
- 最终损失值：
  - Generator损失：0.4616
  - Discriminator损失：0.0278
  - Cycle损失：0.0566
  - Identity损失：0.0505
  - GAN损失：0.6182

### 优化尝试（200-280 epochs）
为了进一步提升模型性能，我们对训练策略进行了以下调整：

1. 学习率调整：
   - 生成器学习率降至0.00008
   - 判别器学习率降至0.00002
   - 引入最小学习率限制（生成器0.000002，判别器0.0000005）
   - 提前开始学习率衰减（第30个epoch）
   - 延长衰减周期（200个epoch）
   - 使用余弦衰减策略

2. 损失权重调整：
   - Cycle Loss权重增加到20.0
   - Identity Loss权重增加到10.0

3. 训练稳定性优化：
   - 减小标签平滑程度（0.05）
   - 调整梯度累积步数（2）
   - 缩短预热阶段（2个epoch）

### 优化后结果（280 epochs）
- FID分数：
  - 照片域FID：47.32（↑5.73）
  - 莫奈域FID：54.84（↑3.61）
  - 平均FID：51.08（↑4.67）
- 损失值：
  - Generator损失：1.42（↑0.96）
  - Discriminator损失：0.15（↑0.12）
  - Cycle损失：0.057（≈）
  - Identity损失：0.053（↑0.003）
  - GAN损失：0.32（↓0.30）

### 结果分析
1. 性能变化：
   - FID分数整体上升，表明生成图像质量有所下降
   - Generator损失显著增加，而GAN损失下降，说明生成器和判别器之间的平衡可能被打破
   - Cycle和Identity损失保持相对稳定，说明内容保持和风格转换的一致性没有明显变化

2. 可能的原因：
   - 学习率调整过于激进，可能导致模型在局部最优解附近震荡
   - 损失权重的增加可能过度强调了某些方面，影响了整体平衡
   - 预热阶段缩短可能影响了模型的初始收敛

3. 经验教训：
   - 模型在200个epoch时已经达到了较好的平衡
   - 过度优化可能破坏已经达到的良好状态
   - 应该更谨慎地调整已经表现良好的模型参数

基于以上分析，建议使用200 epoch时的模型配置和检查点，该配置在生成质量和训练稳定性方面取得了更好的平衡。 

## 注意事项

1. GPU内存使用：
   - FID计算时使用较小的batch size（2）
   - 定期清理GPU缓存
   - 使用混合精度训练降低内存占用

2. 训练稳定性：
   - 监控损失值的突变
   - 关注生成器和判别器的平衡
   - 适时调整学习率

3. 实验监控：
   - 使用Wandb跟踪训练过程
   - 定期检查生成图像质量
   - 监控FID分数变化趋势

## 未来改进

1. 模型架构：
   - 探索注意力机制
   - 尝试不同的归一化方法
   - 优化网络深度和宽度

2. 训练策略：
   - 实现动态学习率调整
   - 研究新的损失函数组合
   - 增加数据增强方法

3. 评估体系：
   - 引入人类评估机制
   - 添加其他定量指标
   - 开发自动化测试流程

## 致谢

本项目基于CycleGAN论文实现：
[Unpaired Image-to-Image Translation using Cycle-Consistent Adversarial Networks](https://arxiv.org/abs/1703.10593)

## License

MIT License 